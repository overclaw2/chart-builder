<div class="container-visualization" (click)="closeContextMenu()">
  <!-- Toast Notification Display -->
  <div class="toast-notification" 
    *ngIf="toastNotification.visible"
    [class.warning]="toastNotification.type === 'warning'"
    [class.danger]="toastNotification.type === 'danger'">
    <span class="toast-message">{{ toastNotification.message }}</span>
  </div>

  <!-- Layout wrapper with 3-column structure: available packages (left), main content (center), side panel (right) -->
  <div class="layout-wrapper">
    <!-- Left Panel: Item Lists (collapsible) -->
    <div class="side-panel" [class.collapsed]="isSidePanelCollapsed">
      <!-- Side Panel Toggle Button (collapse/expand) -->
      <button class="side-panel-toggle" (click)="onToggleSidePanel()" title="Toggle item lists panel">
        <span class="toggle-icon">{{ isSidePanelCollapsed ? '‚ñ∂' : '‚óÄ' }}</span>
        <span class="toggle-label">{{ isSidePanelCollapsed ? 'Items' : 'Hide' }}</span>
      </button>

      <!-- Placed Packages List -->
      <div class="items-list-container" *ngIf="!isSidePanelCollapsed">
        <div class="list-header">
          <h3>‚úÖ Placed Packages</h3>
          <span class="count-badge">{{ getTotalPlacedItems() }}</span>
        </div>
        <div class="items-list" 
          [class.drag-over-remove]="dragOverRemoveZone"
          (dragover)="onDragOverRemoveZone($event)"
          (dragleave)="onDragLeaveRemoveZone($event)"
          (drop)="onDropToRemove($event)">
          <div class="list-item placed" 
            *ngFor="let item of getPlacedItems()"
            draggable="true"
            (dragstart)="onDragStartPlacedItem($event, item)">
            <div class="item-info">
              <div class="item-label">{{ item.name }}</div>
              <div class="item-specs">{{ item.dimensionMcm }} Mcm √ó {{ item.weightKg }} Kg</div>
            </div>
            <div class="item-location">
              <span class="location-badge">{{ item.location }}</span>
            </div>
            <!-- Close button (X icon) to remove item from placed items -->
            <button class="close-btn" (click)="onRemoveFromPlacedItems(item, $event)" title="Remove from chart">
              ‚úï
            </button>
          </div>
          <div class="empty-state" *ngIf="getTotalPlacedItems() === 0">
            No packages placed yet
          </div>
          <div class="remove-hint" *ngIf="getTotalPlacedItems() > 0 && dragOverRemoveZone">
            Drop here to move package back to Available packages
          </div>
        </div>
      </div>
    </div>

    <!-- Center + Right: Available Packages and Main Content -->
    <div class="content-wrapper">
      <!-- Left Panel: Available Packages (draggable items pool) -->
      <app-available-packages
        [isCollapsed]="isAvailablePackagesPanelCollapsed"
        (toggleCollapse)="onToggleAvailablePackagesPanel()"
        (dragStart)="onAvailablePackageDragStart($event)"
      ></app-available-packages>

      <!-- Main content area with charts -->
      <div class="main-content">
      <div class="header-section">
        <h1 class="title">{{ shipData?.title }}</h1>
    
    <!-- JSON Upload & History & Help Section -->
    <div class="upload-section">
      <div class="upload-controls">
        <input
          type="file"
          #fileInput
          (change)="onFileSelected($event)"
          accept=".json"
          hidden
        />
        <input
          type="file"
          #conveyorConfigInput
          (change)="onConveyorConfigSelected($event)"
          accept=".json"
          hidden
        />
        <button class="upload-btn" (click)="fileInput.click()" title="Load JSON data">
          üì§ Load JSON Data
        </button>
        <button class="conveyor-config-btn" (click)="conveyorConfigInput.click()" title="Load conveyor configuration">
          üìã Load Conveyor Config
        </button>
        <button class="reset-btn" (click)="onResetToMock()" title="Reset to mock data">
          üîÑ Reset to Mock
        </button>
        <button class="history-btn" (click)="toggleHistoryViewer()" title="Toggle history viewer (Ctrl+Z to undo, Ctrl+Y to redo)">
          üìú History
        </button>
        <button class="snapshot-btn" (click)="toggleSnapshotTimeline()" title="View snapshot timeline and comparisons">
          üì∏ Snapshots
        </button>
        <button class="help-btn" (click)="toggleHelpPanel()" title="Open help & documentation">
          ‚ùì Help
        </button>
        <span class="upload-status" *ngIf="loadingMessage">{{ loadingMessage }}</span>
      </div>
    </div>

    <!-- TASK 2: Search and Filter Section -->
    <div class="search-filter-section">
      <!-- Search Header with Collapse Toggle -->
      <div class="search-filter-header">
        <h3 class="search-title">üîç Search & Filter</h3>
        <button 
          class="search-collapse-btn" 
          (click)="onToggleSearchCollapse()"
          [title]="isSearchCollapsed ? 'Expand search' : 'Collapse search'"
        >
          {{ isSearchCollapsed ? '‚ñº' : '‚ñ≤' }}
        </button>
      </div>

      <!-- Search Filters (Collapsible) -->
      <div class="search-filter-container" [class.collapsed]="isSearchCollapsed">
        <!-- Search Filters Row 1: Name, Destination, ID -->
        <div class="filter-row">
          <div class="filter-group">
            <label for="search-name">Package Name</label>
            <input
              id="search-name"
              type="text"
              placeholder="Search by name..."
              [(ngModel)]="searchFilters.name"
              (input)="onSearchFilterChange()"
              class="filter-input"
            />
          </div>
          <div class="filter-group">
            <label for="search-destination">Destination</label>
            <input
              id="search-destination"
              type="text"
              placeholder="Search by destination..."
              [(ngModel)]="searchFilters.destination"
              (input)="onSearchFilterChange()"
              class="filter-input"
            />
          </div>
          <div class="filter-group">
            <label for="search-id">Package ID</label>
            <input
              id="search-id"
              type="text"
              placeholder="Search by ID..."
              [(ngModel)]="searchFilters.id"
              (input)="onSearchFilterChange()"
              class="filter-input"
            />
          </div>
        </div>

        <!-- Search Filters Row 2: Weight Range, Dimension Range -->
        <div class="filter-row">
          <div class="filter-group">
            <label for="search-weight-min">Weight Min (Kg)</label>
            <input
              id="search-weight-min"
              type="number"
              placeholder="Min weight..."
              [(ngModel)]="searchFilters.weightMin"
              (input)="onSearchFilterChange()"
              class="filter-input numeric"
            />
          </div>
          <div class="filter-group">
            <label for="search-weight-max">Weight Max (Kg)</label>
            <input
              id="search-weight-max"
              type="number"
              placeholder="Max weight..."
              [(ngModel)]="searchFilters.weightMax"
              (input)="onSearchFilterChange()"
              class="filter-input numeric"
            />
          </div>
          <div class="filter-group">
            <label for="search-dimension-min">Dimension Min (Mcm)</label>
            <input
              id="search-dimension-min"
              type="number"
              placeholder="Min dimension..."
              [(ngModel)]="searchFilters.dimensionMin"
              (input)="onSearchFilterChange()"
              class="filter-input numeric"
            />
          </div>
          <div class="filter-group">
            <label for="search-dimension-max">Dimension Max (Mcm)</label>
            <input
              id="search-dimension-max"
              type="number"
              placeholder="Max dimension..."
              [(ngModel)]="searchFilters.dimensionMax"
              (input)="onSearchFilterChange()"
              class="filter-input numeric"
            />
          </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
          <button
            class="clear-filters-btn"
            (click)="clearFilters()"
            [disabled]="!hasActiveFilters()"
            title="Clear all filters"
          >
            üîÑ Clear Filters
          </button>
          <span class="filter-results-info" *ngIf="hasActiveFilters()">
            Showing {{ getTotalFilteredItems() }} of {{ getTotalPlacedItems() }} packages
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="containers-list" *ngIf="getDisplayShipData()">
    <div class="container-card" *ngFor="let container of getDisplayShipData()!.containers; let idx = index">
      <!-- Compartments within container -->
      <div class="compartment-group" *ngFor="let compartment of container.compartments">
        <!-- Compartment Header -->
        <div class="container-header">
          <div class="container-info">
            <div class="container-order-controls">
              <button class="order-btn" 
                (click)="onMoveContainerUp(container.id)" 
                [disabled]="idx === 0"
                title="Move container up">
                ‚Üë
              </button>
              <span class="container-order-index">{{ idx + 1 }}/{{ getDisplayShipData()!.containers.length }}</span>
              <button class="order-btn" 
                (click)="onMoveContainerDown(container.id)" 
                [disabled]="idx === getDisplayShipData()!.containers.length - 1"
                title="Move container down">
                ‚Üì
              </button>
            </div>
            <a href="#" class="container-link">
              {{ container.name }} ({{ compartment.index }}/{{ container.compartments.length }})
            </a>
            <div class="metadata">
              widthindex {{ compartment.widthindexStart }} Mcm - {{ compartment.widthindexEnd }} Mcm | Width {{ compartment.widthMcm }} Cm - {{ compartment.widthUtilization }}% width utilization | Weight {{ compartment.weightKg }} Kg - {{ compartment.weightUtilization }}% compartment weight utilization
            </div>
          </div>
          <div class="controls">
            <!-- TODO 3: Color picker for compartment -->
            <div class="compartment-color-picker" title="Change compartment color">
              <input
                type="color"
                class="compartment-color-input"
                [value]="getCompartmentColor(compartment)"
                (change)="onCompartmentColorChange($event, compartment)"
              />
              <span class="color-icon">üé®</span>
            </div>
            
            <button class="icon-btn" (click)="onDownload(compartment)" title="Download">
              ‚Üì
            </button>
            <button class="icon-btn" (click)="onRefresh()" title="Refresh">
              ‚Üª
            </button>
            <select class="filter-select">
              <option>None</option>
              <option selected>All</option>
            </select>
          </div>
        </div>

        <!-- Top Axis with Range and Package Highlighting (Avihai's requirement) -->
        <div class="axis-wrapper">
          <!-- Range labels above timeline strip -->
          <div class="axis-labels-top">
            <div class="axis-range-label axis-start-label">{{ compartment.widthindexStart }}</div>
            <div class="axis-range-label axis-end-label">{{ compartment.widthindexEnd }}</div>
          </div>
          
          <!-- Timeline strip (full width, with labels overlay) -->
          <div class="top-axis">
            <div class="axis-track">
              <!-- Ghost highlight while dragging a package -->
              <!-- FIX: Only show ghost highlight on the CORRECT container and compartment -->
              <!-- This ensures ghost is properly isolated and doesn't appear on other containers' timeline strips -->
              <div 
                class="axis-highlight-ghost" 
                *ngIf="ghostHighlight && ghostHighlight.containerId === container.id && ghostHighlight.compartmentId === compartment.id"
                [ngStyle]="{ left: ghostHighlight.left, width: ghostHighlight.width }"
              ></div>
              
              <!-- Ghost Label with Vertical Connector (only visible when dragging) -->
              <div class="axis-label-with-connector ghost-label" 
                *ngIf="ghostHighlight && ghostHighlight.containerId === container.id && ghostHighlight.compartmentId === compartment.id && draggedItem"
                [ngStyle]="getGhostLabelPosition()">
                <div class="axis-label-connector"></div>
                <div class="axis-label-text">{{ dragTooltip.index }}</div>
              </div>
              
              <!-- Highlight areas where packages are located -->
              <div 
                class="axis-highlight" 
                *ngFor="let item of compartment.items"
                [ngStyle]="getAxisHighlightPosition(item, compartment)"
              ></div>
              
              <!-- Package Index Labels with Vertical Connectors (positioned absolutely for each item) -->
              <div class="axis-label-with-connector" 
                *ngFor="let item of compartment.items"
                [ngStyle]="getAxisLabelPosition(item, compartment)">
                <div class="axis-label-connector"></div>
                <div class="axis-label-text">{{ item.displayIndex || getCentralPositionIndex(item) }}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Capacity Warning Indicator -->
        <div class="capacity-indicator" *ngIf="capacityWarnings[compartment.id]" 
          [style.borderColor]="getCompartmentWarningColor(compartment.id)"
          [style.borderLeftColor]="getCompartmentWarningColor(compartment.id)">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <span class="warning-text">
            Weight: {{ capacityWarnings[compartment.id].weight.toFixed(1) }}% | 
            Width: {{ capacityWarnings[compartment.id].width.toFixed(1) }}%
          </span>
        </div>

        <!-- Compartment Bar -->
        <div
          class="container-bar-wrapper"
          [class.drag-over]="dragOverCompartmentId === compartment.id"
          [style.borderColor]="getCompartmentWarningColor(compartment.id)"
          [style.borderWidth]="capacityWarnings[compartment.id] ? '3px' : '1px'"
          (dragover)="draggedAvailablePackage ? onDragOverFromAvailable($event, compartment.id) : onDragOver($event, compartment.id)"
          (dragleave)="onDragLeave($event, compartment.id)"
          (drop)="draggedAvailablePackage ? onDropFromAvailablePackages($event, container.id, compartment.id) : onDrop($event, container.id, compartment.id)"
          [style.--compartment-bg]="getCompartmentColor(compartment)"
        >
          <!-- Drag tooltip removed - position badge updates while dragging instead -->
          
          <!-- Drop zone visual feedback - grid overlay showing valid drop areas -->
          <div class="drop-zones-grid" *ngIf="dragOverCompartmentId === compartment.id">
            <div class="drop-zone-grid-line" *ngFor="let zone of getDropZones(compartment)" [ngStyle]="zone"></div>
          </div>
          
          <div class="container-bar">
            <div class="item-wrapper" *ngFor="let item of compartment.items" [ngStyle]="getItemPosition(item, compartment)" [attr.data-item-id]="item.id">
              
              <div
                class="item"
                draggable="true"
                (dragstart)="onDragStart($event, container.id, compartment.id, item)"
                (mouseenter)="onItemMouseEnter(item.id, $event)"
                (mousemove)="onItemMouseMove(item.id, $event)"
                (mouseleave)="onItemMouseLeave()"
                (contextmenu)="onItemContextMenu($event, container.id, compartment.id, item.id)"
                [style.backgroundColor]="getItemColor(item)"
                [attr.data-item-id]="item.id"
                [title]="item.name"
              >
                <!-- FIX 1: Smart label rendering - truncates long names and uses compact vertical layout -->
                <div class="item-content">
                  <!-- PROBLEM 1 FIX: Truncate long package names to 15 chars with ellipsis -->
                  <div class="item-name" [title]="item.name">
                    {{ truncateText(item.name, 15) }}
                  </div>
                  <!-- Only show details if item is wide enough (> 80px) -->
                  <div class="item-detail" *ngIf="shouldShowDetails(item, compartment)">
                    {{ item.dimensionMcm }}Mcm
                  </div>
                  <div class="item-detail" *ngIf="shouldShowDetails(item, compartment)">
                    {{ item.weightKg }}Kg
                  </div>
                  <!-- Destination only on very wide items (> 120px) -->
                  <div class="item-destination" *ngIf="shouldShowDestination(item, compartment)">
                    {{ truncateText(item.destination, 10) }}
                  </div>
                </div>
                <!-- AVIHAI FIX #2: Central position width index badge centered on package -->
                <!-- Updates position while dragging - displayIndex is updated in real-time -->
                <div class="item-central-position-badge" title="Central position width index">
                  üìç {{ item.displayIndex || getCentralPositionIndex(item) }}
                </div>
                
                <!-- TASK 5: Conv button to open popup with package details -->
                <button class="conv-button" (click)="openConvPopup(item, $event)" title="Open package details window">
                  conv
                </button>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
      </div>
    </div>
  </div>

  <!-- Context Menu for right-click item removal -->
  <div class="context-menu" *ngIf="contextMenu.visible" [ngStyle]="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" (click)="$event.stopPropagation()">
    <div class="context-menu-item" (click)="onRemoveItem()">
      üóëÔ∏è Remove Item
    </div>
  </div>

  <!-- HOVER TOOLTIP: Global overlay tooltip to prevent clipping by overflow hidden containers -->
  <div class="item-hover-tooltip-overlay" 
    *ngIf="tooltipState.visible && tooltipState.item"
    [style.left.px]="tooltipState.x"
    [style.top.px]="tooltipState.y">
    <div class="tooltip-title">{{ tooltipState.item.name }}</div>
    <div class="tooltip-row">
      <span class="tooltip-label">Width:</span>
      <span class="tooltip-value">{{ tooltipState.item.dimensionMcm }} Mcm</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Weight:</span>
      <span class="tooltip-value">{{ tooltipState.item.weightKg }} Kg</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Destination:</span>
      <span class="tooltip-value">{{ tooltipState.item.destination }}</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Position:</span>
      <span class="tooltip-value">{{ getCentralPositionIndex(tooltipState.item) }}</span>
    </div>
    <div class="tooltip-row">
      <span class="tooltip-label">Compartment Use:</span>
      <span class="tooltip-value">{{ getTooltipCompartmentUtilization(tooltipState.item) }}%</span>
    </div>
    <!-- Compartment Indicators: Fixed values from placed item (not updated during drag) -->
    <div class="tooltip-compartment-indicators">
      <div class="tooltip-indicator tooltip-start-indicator">
        {{ getOriginalItemStartIndex(tooltipState.item) }}
      </div>
      <div class="tooltip-indicator tooltip-stop-indicator">
        {{ getOriginalItemStopIndex(tooltipState.item) }}
      </div>
    </div>
  </div>

  <!-- FLOATING DRAG LABELS: Compartment indicators that follow the dragged item -->
  <div class="floating-drag-labels-overlay"
    *ngIf="dragTooltip.visible && draggedItem"
    [style.left.px]="dragLabelPosition.x"
    [style.top.px]="dragLabelPosition.y">
    <div class="drag-label-item drag-label-start">
      {{ dragTooltip.startIndex }}
    </div>
    <div class="drag-label-item drag-label-stop">
      {{ dragTooltip.stopIndex }}
    </div>
  </div>

  <!-- TASK 5: Conveyor Allocation Window - New Design -->
  <div class="conv-popup-backdrop" *ngIf="convPopup.visible" (click)="onConvPopupBackdropClick($event)">
    <div class="conveyor-window" *ngIf="convPopup.item && getConveyorData(convPopup.item) as conveyorData">
      <!-- Header -->
      <div class="conveyor-header">
        <div class="header-content">
          <h2>{{ conveyorData.title }} <span class="mode-badge" [class.new]="conveyorData.mode === 'new'" [class.edit]="conveyorData.mode === 'edit'">{{ conveyorData.mode | uppercase }}</span></h2>
        </div>
        <span class="close-icon" (click)="closeConvPopup()" title="Close">‚úï</span>
      </div>

      <!-- Conveyor Content with Hierarchical Tree Structure -->
      <div class="conveyor-content">
        <!-- Tree Title -->
        <div class="tree-title">
          <h3>Allocation Areas & Sections</h3>
          <span class="tree-subtitle">Expand areas to view sections</span>
        </div>

        <!-- Hierarchical Tree Structure -->
        <div class="conveyor-tree">
          <!-- Area Nodes (Level 1) -->
          <div class="tree-node tree-level-0" *ngFor="let area of conveyorData.areas">
            <!-- Area Header with Expand/Collapse Toggle -->
            <div class="tree-node-header" [class.selected]="selectedConveyorArea === area.id" (click)="toggleConveyorAreaExpansion(area.id)">
              <div class="tree-expand-icon" [class.expanded]="area.expanded">
                <span class="expand-toggle">{{ area.expanded ? '‚ñº' : '‚ñ∂' }}</span>
              </div>
              <div class="tree-node-content">
                <span class="area-name" [class.highlighted]="area.highlighted">
                  {{ area.name }}
                </span>
                <span class="area-range">
                  ({{ area.startIndex }} - {{ area.endIndex }})
                </span>
              </div>
              <div class="tree-node-badge">
                {{ area.expanded ? 'Expanded' : 'Collapsed' }}
              </div>
            </div>

            <!-- Sections (Level 1 - shown when area is expanded) -->
            <div class="tree-children" *ngIf="area.expanded" [@slideDown]>
              <!-- Section Nodes -->
              <div class="tree-node tree-level-1" *ngFor="let section of area.sections">
                <!-- Section Header -->
                <div class="tree-node-header section-header">
                  <div class="tree-expand-icon disabled">
                    <span class="section-icon">‚ñ∏</span>
                  </div>
                  <div class="tree-node-content">
                    <span class="section-name">{{ section.name }}</span>
                    <span class="section-range">
                      ({{ section.startRange }} - {{ section.endRange }})
                    </span>
                  </div>
                </div>

                <!-- Allocation Grid (Level 2 - always shown for sections) -->
                <div class="tree-children tree-grid-container">
                  <div class="section-details">
                    <div class="allocation-grid">
                      <div *ngFor="let cell of section.cells" 
                        class="grid-cell"
                        [class.allocated]="cell.allocated"
                        [style.backgroundColor]="cell.color"
                        [title]="'Cell ' + cell.value">
                        {{ cell.value }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Package Info -->
        <div class="package-info">
          <p><strong>Package name:</strong> {{ convPopup.item.name }}</p>
          <p><strong>Category:</strong> Cargo</p>
          <p><strong>Width:</strong> {{ convPopup.item.dimensionMcm }}</p>
          <p><strong>Cells:</strong> {{ conveyorData.allocatedCells }}</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="conveyor-footer">
        <button class="btn-cancel" (click)="closeConvPopup()">Cancel</button>
        <button class="btn-allocate" (click)="onAllocatePackage()">Allocate</button>
      </div>
    </div>
  </div>

  <!-- Bulk Import Component -->
  <app-bulk-import 
    [existingPackages]="getExistingPackagesForBulkImport()"
    (packagesImported)="onBulkImportComplete($event)">
  </app-bulk-import>

  <!-- History Viewer Panel -->
  <app-history-viewer 
    [isOpen]="historyViewerOpen"
    (isOpenChange)="historyViewerOpen = $event"
    (stateSelected)="onHistoryStateSelected($event)">
  </app-history-viewer>

  <!-- Help Panel -->
  <app-help-panel 
    [isOpen]="helpPanelOpen"
    (isOpenChange)="helpPanelOpen = $event">
  </app-help-panel>

  <!-- Snapshot Timeline Modal/Panel -->
  <div class="snapshot-modal-overlay" *ngIf="snapshotTimelineOpen" (click)="toggleSnapshotTimeline()">
    <div class="snapshot-modal-content" (click)="$event.stopPropagation()">
      <div class="snapshot-modal-header">
        <h2>üì∏ Snapshot Timeline & Comparison</h2>
        <button class="close-modal-btn" (click)="toggleSnapshotTimeline()">‚úï</button>
      </div>
      <app-snapshot-timeline
        [shipData]="shipData"
        (snapshotRestored)="onSnapshotRestored($event)">
      </app-snapshot-timeline>
    </div>
  </div>

  <!-- Tour Overlay -->
  <app-tour-overlay></app-tour-overlay>

  <!-- Toast Notification for Capacity Warnings -->
  <div class="capacity-toast" [class.visible]="toastNotification.visible" [class]="'type-' + toastNotification.type">
    {{ toastNotification.message }}
  </div>
</div>
