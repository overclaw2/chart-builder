<div class="container-visualization" (click)="closeContextMenu()">
  <!-- Layout wrapper for charts and side panels -->
  <div class="layout-wrapper">
    <!-- Main content area with charts -->
    <div class="main-content">
      <div class="header-section">
        <h1 class="title">{{ shipData?.title }}</h1>
    
    <!-- JSON Upload Section -->
    <div class="upload-section">
      <div class="upload-controls">
        <input
          type="file"
          #fileInput
          (change)="onFileSelected($event)"
          accept=".json"
          hidden
        />
        <button class="upload-btn" (click)="fileInput.click()" title="Load JSON data">
          üì§ Load JSON Data
        </button>
        <button class="reset-btn" (click)="onResetToMock()" title="Reset to mock data">
          üîÑ Reset to Mock
        </button>
        <span class="upload-status" *ngIf="loadingMessage">{{ loadingMessage }}</span>
      </div>
    </div>
  </div>

  <div class="containers-list" *ngIf="shipData">
    <div class="container-card" *ngFor="let container of shipData.containers">
      <!-- Compartments within container -->
      <div class="compartment-group" *ngFor="let compartment of container.compartments">
        <!-- Compartment Header -->
        <div class="container-header">
          <div class="container-info">
            <a href="#" class="container-link">
              {{ container.name }} ({{ compartment.index }}/{{ container.compartments.length }})
            </a>
            <div class="metadata">
              widthindex {{ compartment.widthindexStart }} Mcm - {{ compartment.widthindexEnd }} Mcm | Width {{ compartment.widthMcm }} Cm - {{ compartment.widthUtilization }}% width utilization | Weight {{ compartment.weightKg }} Kg - {{ getContainerWeightUtilization(container) }}% container weight utilization
            </div>
          </div>
          <div class="controls">
            <!-- TODO 3: Color picker for compartment -->
            <div class="compartment-color-picker" title="Change compartment color">
              <input
                type="color"
                class="compartment-color-input"
                [value]="getCompartmentColor(compartment)"
                (change)="onCompartmentColorChange($event, compartment)"
              />
              <span class="color-icon">üé®</span>
            </div>
            
            <button class="icon-btn" (click)="onDownload(compartment)" title="Download">
              ‚Üì
            </button>
            <button class="icon-btn" (click)="onRefresh()" title="Refresh">
              ‚Üª
            </button>
            <select class="filter-select">
              <option>None</option>
              <option selected>All</option>
            </select>
          </div>
        </div>

        <!-- Top Axis with Range and Package Highlighting (Avihai's requirement) -->
        <div class="axis-wrapper">
          <div class="top-axis">
            <div class="axis-label">{{ compartment.widthindexStart }}</div>
            <div class="axis-track">
              <!-- Highlight areas where packages are located -->
              <div 
                class="axis-highlight" 
                *ngFor="let item of compartment.items"
                [ngStyle]="getAxisHighlightPosition(item, compartment)"
              ></div>
            </div>
            <div class="axis-label">{{ compartment.widthindexEnd }}</div>
          </div>
        </div>

        <!-- Compartment Bar -->
        <div
          class="container-bar-wrapper"
          [class.drag-over]="dragOverCompartmentId === compartment.id"
          (dragover)="onDragOver($event, compartment.id)"
          (dragleave)="onDragLeave($event, compartment.id)"
          (drop)="onDrop($event, container.id, compartment.id)"
          [style.--compartment-bg]="getCompartmentColor(compartment)"
        >
          <!-- Drag tooltip (shows current index while dragging) -->
          <div class="drag-tooltip" *ngIf="dragTooltip.visible && dragOverCompartmentId === compartment.id">
            üìç Index: {{ dragTooltip.index }}
          </div>
          
          <!-- Drop zone visual feedback - grid overlay showing valid drop areas -->
          <div class="drop-zones-grid" *ngIf="dragOverCompartmentId === compartment.id">
            <div class="drop-zone-grid-line" *ngFor="let zone of getDropZones(compartment)" [ngStyle]="zone"></div>
          </div>
          
          <div class="container-bar">
            <div class="item-wrapper" *ngFor="let item of compartment.items" [ngStyle]="getItemPosition(item, compartment)" [attr.data-item-id]="item.id">
              <div
                class="item"
                draggable="true"
                (dragstart)="onDragStart($event, container.id, compartment.id, item)"
                (mouseenter)="onItemMouseEnter(item.id, $event)"
                (mouseleave)="onItemMouseLeave()"
                (contextmenu)="onItemContextMenu($event, container.id, compartment.id, item.id)"
                [style.backgroundColor]="getItemColor(item)"
                [attr.data-item-id]="item.id"
              >
                <div class="item-content">
                  <div class="item-name">{{ item.name }}</div>
                  <div class="item-detail">{{ item.dimensionMcm }} [Mcm]</div>
                  <div class="item-detail">{{ item.weightKg }} [Kg]</div>
                  <div class="item-destination">{{ item.destination }}</div>
                  <div class="item-color-picker">
                    <input
                      type="color"
                      [value]="getItemColor(item)"
                      (change)="onColorChange($event, item)"
                      title="Click to change color"
                      class="color-input"
                    />
                  </div>
                </div>
                <!-- AVIHAI FIX #2: Central position width index badge centered on package -->
                <!-- Positioned in the center of the package, not below it -->
                <div class="item-central-position-badge" title="Central position width index">
                  üìç {{ getCentralPositionIndex(item) }}
                </div>
                
                <!-- AVIHAI FIX #1: Hover tooltip with package data (appears on hover, not just drag) -->
                <!-- TODO 4: Positioned above or below package depending on available space -->
                <div class="item-hover-tooltip" [class.visible]="hoveredItemId === item.id" [ngClass]="getTooltipPositioning(item.id)">
                  <div class="tooltip-title">{{ item.name }}</div>
                  <div class="tooltip-row">
                    <span class="tooltip-label">Width:</span>
                    <span class="tooltip-value">{{ item.dimensionMcm }} Mcm</span>
                  </div>
                  <div class="tooltip-row">
                    <span class="tooltip-label">Weight:</span>
                    <span class="tooltip-value">{{ item.weightKg }} Kg</span>
                  </div>
                  <div class="tooltip-row">
                    <span class="tooltip-label">Destination:</span>
                    <span class="tooltip-value">{{ item.destination }}</span>
                  </div>
                </div>
              </div>
              <!-- Display index below item (legacy) -->
              <div class="item-index" *ngIf="item.displayIndex !== undefined">
                {{ item.displayIndex }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Side panel with item lists -->
    <div class="side-panel">
      <!-- Available Items List -->
      <div class="items-list-container">
        <div class="list-header">
          <h3>üì¶ Available Items</h3>
          <span class="count-badge">{{ getTotalAvailableItems() }}</span>
        </div>
        <div class="items-list">
          <div class="list-item" *ngFor="let item of getAvailableItems()">
            <div class="item-info">
              <div class="item-label">{{ item.name }}</div>
              <div class="item-specs">{{ item.dimensionMcm }} Mcm √ó {{ item.weightKg }} Kg</div>
            </div>
            <div class="item-location">
              <span class="location-badge">{{ item.destination }}</span>
            </div>
          </div>
          <div class="empty-state" *ngIf="getTotalAvailableItems() === 0">
            No items available
          </div>
        </div>
      </div>

      <!-- Placed Items List -->
      <div class="items-list-container">
        <div class="list-header">
          <h3>‚úÖ Placed Items</h3>
          <span class="count-badge">{{ getTotalPlacedItems() }}</span>
        </div>
        <div class="items-list">
          <div class="list-item placed" *ngFor="let item of getPlacedItems()">
            <div class="item-info">
              <div class="item-label">{{ item.name }}</div>
              <div class="item-specs">{{ item.dimensionMcm }} Mcm √ó {{ item.weightKg }} Kg</div>
            </div>
            <div class="item-location">
              <span class="location-badge">{{ item.location }}</span>
            </div>
          </div>
          <div class="empty-state" *ngIf="getTotalPlacedItems() === 0">
            No items placed yet
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Context Menu for right-click item removal -->
  <div class="context-menu" *ngIf="contextMenu.visible" [ngStyle]="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" (click)="$event.stopPropagation()">
    <div class="context-menu-item" (click)="onRemoveItem()">
      üóëÔ∏è Remove Item
    </div>
  </div>
</div>
