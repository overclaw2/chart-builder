<div class="conveyor-allocator-container">
  <!-- Header -->
  <div class="allocator-header">
    <h2>Conveyor Cell Allocator</h2>
    <button class="config-btn" (click)="showConfigUpload = !showConfigUpload" title="Load configuration">
      ⚙️ Config
    </button>
  </div>

  <!-- Config Upload Section -->
  <div *ngIf="showConfigUpload" class="config-upload-section">
    <label for="configFile">Load Configuration (JSON):</label>
    <input 
      #configFile 
      type="file" 
      id="configFile" 
      accept=".json"
      (change)="onConfigFileSelected($event)"
      hidden
    />
    <button (click)="configFile.click()" class="upload-btn">Choose File</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="config" class="allocator-content">
    <!-- Tab Bar: Conveyor Selection (Level 1) -->
    <div class="level-1-tabs">
      <h3 class="tabs-label">Select Conveyor</h3>
      <div class="conveyor-tabs">
        <button
          *ngFor="let conveyor of conveyors"
          [class.active]="uiState.activeConveyor === conveyor.conveyorId"
          (click)="selectConveyorTab(conveyor.conveyorId)"
          class="tab-btn"
          [title]="'Switch to ' + conveyor.conveyorName"
        >
          {{ conveyor.conveyorName }}
        </button>
      </div>
    </div>

    <!-- Level 2: Area Selection -->
    <div *ngIf="uiState.activeConveyor" class="level level-2">
      <h3>Level 2: Select Area</h3>
      
      <!-- Index width labels -->
      <div class="index-width-labels" *ngIf="getAvailableAreas().length > 0">
        <span class="label-left">{{ getAvailableAreas()[0].startWidthIndex }} Mcm</span>
        <span class="label-right">{{ getAvailableAreas()[getAvailableAreas().length - 1].stopWidthIndex }} Mcm</span>
      </div>

      <div class="button-group">
        <button 
          *ngFor="let area of getAvailableAreas()"
          [class.active]="uiState.activeArea === area.name"
          (click)="toggleArea(area.name)"
          class="level-btn area-btn"
          [style.flex]="'1'"
        >
          <span class="area-label">{{ uiState.activeConveyor }}-{{ area.name }}</span>
          <span class="area-range">{{ area.startWidthIndex }}-{{ area.stopWidthIndex }}</span>
        </button>
      </div>
    </div>

    <!-- Level 3 & 4: Sections and Cells -->
    <div *ngIf="uiState.activeConveyor && uiState.activeArea" class="level level-3">
      <h3>Level 3: Sections (Click to toggle open/close)</h3>
      
      <!-- Sections Row (aligned right, distributed evenly) -->
      <div class="sections-row">
        <div 
          *ngFor="let section of configService.getSections(uiState.activeConveyor, uiState.activeArea)"
          class="section-wrapper"
        >
          <!-- Section Toggle Button -->
          <button 
            (click)="toggleSection(section.name)"
            [class.open]="isSectionOpen(section.name)"
            class="section-button"
          >
            <span class="toggle-icon">{{ getSectionToggleIcon(section.name) }}</span>
            <span class="section-name">{{ section.name }}</span>
            <span class="section-range">({{ section.startWidthIndex }}-{{ section.stopWidthIndex }})</span>
          </button>

          <!-- Section Panel (shown when section is open) -->
          <div *ngIf="isSectionOpen(section.name)" class="level-4-panel">
            <!-- Package Info -->
            <div class="package-info">
              <div class="info-row">
                <span class="label">Package:</span>
                <span class="value">{{ uiState.currentPackage?.name }}</span>
              </div>
              <div class="info-row">
                <span class="label">Category:</span>
                <span class="value">{{ uiState.currentPackage?.category }}</span>
              </div>
              <div class="info-row">
                <span class="label">Width:</span>
                <span class="value">{{ uiState.currentPackage?.width }} Mcm</span>
              </div>
              <div class="info-row">
                <span class="label">Cells Required:</span>
                <span class="value">{{ uiState.currentPackage?.cells }}</span>
              </div>
            </div>

            <!-- Cell Grid -->
            <div class="cell-grid">
              <button
                *ngFor="let cell of section.cells"
                [class.selected]="isCellSelected(section.name, cell.index)"
                [class.allocated]="getAllocatedCellInfo(section.name, cell.index) !== null"
                [class.disabled]="!canSelectCell(section.name, cell.index)"
                [style.backgroundColor]="getCellBackgroundColor(section.name, cell.index)"
                [style.color]="getCellTextColor(section.name, cell.index)"
                (click)="handleCellClick(section.name, cell.index)"
                (mouseover)="showTooltip($event, section.name, cell.index)"
                (mouseout)="hideTooltip()"
                class="cell-btn"
                [disabled]="!canSelectCell(section.name, cell.index)"
                [title]="getCellTooltip(section, cell.index)"
              >
                {{ cell.index }}
              </button>
            </div>

            <!-- Cell Range Display -->
            <div class="cell-range-display" *ngIf="isSectionOpen(section.name)">
              <span class="range-label">Width Range: {{ section.startWidthIndex }} - {{ section.stopWidthIndex }} Mcm</span>
              <span class="cell-count">Total Cells: {{ section.cells.length }}</span>
            </div>

            <!-- Tooltip -->
            <div 
              *ngIf="tooltipCell && tooltipCell.sectionId === section.name"
              class="tooltip"
              [style.left.px]="tooltipPosition?.x || 0"
              [style.top.px]="tooltipPosition?.y || 0"
            >
              {{ getCellTooltip(section, tooltipCell.cellIndex) }}
            </div>
          </div>
        </div> <!-- end section-wrapper -->
      </div> <!-- end sections-row -->
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button (click)="onCancel()" class="cancel-btn">Cancel</button>
      <button 
        (click)="onAllocate()" 
        [disabled]="!isAllocateButtonEnabled()"
        class="allocate-btn"
      >
        Allocate
      </button>
    </div>
  </div>

  <!-- Error Message if no config -->
  <div *ngIf="!config" class="no-config-message">
    <p>Please load a configuration file to get started.</p>
    <button (click)="showConfigUpload = true" class="config-btn">Load Configuration</button>
  </div>
</div>
